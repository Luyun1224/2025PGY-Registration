<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGY èªªæ˜æœƒå ±ååˆ†æå„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: 2px solid transparent;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .stat-card.active {
            border-color: #14b8a6; /* teal-500 */
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">PGY èªªæ˜æœƒå ±åå„€è¡¨æ¿</h1>
                <p class="text-gray-500 mt-1">å³æ™‚å ±åæ•¸æ“šåˆ†æç¸½è¦½ (é»æ“Šä¸‹æ–¹å¡ç‰‡å¯ç¯©é¸)</p>
            </div>
            <div class="flex items-center mt-4 sm:mt-0">
                <span id="last-updated" class="text-sm text-gray-400 mr-4"></span>
                <button id="refresh-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition">
                    <svg id="refresh-icon" class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4l-4 4M4 20l4-4" />
                    </svg>
                    <span id="refresh-text">æ‰‹å‹•æ›´æ–°</span>
                </button>
            </div>
        </header>

        <div id="loading-spinner" class="text-center py-20">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-teal-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">æ­£åœ¨å¾ Google Sheet è¼‰å…¥æœ€æ–°æ•¸æ“š...</p>
        </div>

        <main id="dashboard-content" class="hidden">
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div id="filter-All" data-filter="All" class="stat-card bg-white p-6 rounded-xl shadow cursor-pointer active">
                    <h2 class="text-gray-500 text-lg font-semibold">ç¸½å ±åäººæ•¸ (ç¶œåˆ)</h2>
                    <p id="total-count" class="text-5xl font-extrabold text-teal-600 mt-2">0</p>
                </div>
                <div id="filter-ä¸Šåˆ" data-filter="ä¸Šåˆ" class="stat-card bg-white p-6 rounded-xl shadow cursor-pointer">
                    <h2 class="text-gray-500 text-lg font-semibold">â˜€ï¸ ä¸Šåˆå ´</h2>
                    <p id="morning-count" class="text-5xl font-extrabold text-cyan-600 mt-2">0</p>
                </div>
                <div id="filter-ä¸‹åˆ" data-filter="ä¸‹åˆ" class="stat-card bg-white p-6 rounded-xl shadow cursor-pointer">
                    <h2 class="text-gray-500 text-lg font-semibold">ğŸŒ™ ä¸‹åˆå ´</h2>
                    <p id="afternoon-count" class="text-5xl font-extrabold text-indigo-600 mt-2">0</p>
                </div>
            </section>

            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow">
                    <h2 id="chart-title" class="text-xl font-bold text-gray-700 mb-4">å„æ ¡å ±åäººæ•¸åˆ†ä½ˆ (ç¶œåˆ)</h2>
                    <div class="h-96">
                        <canvas id="school-chart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow">
                    <h2 id="list-title" class="text-xl font-bold text-gray-700 mb-4">è©³ç´°æ•¸æ“šåˆ—è¡¨ (ç¶œåˆ)</h2>
                    <div id="school-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzqQl2-FFP2OValNMlIC9WRLd8iCV__Mgk8og3CZmmAWtDdgpiwFpbFQE00ZUiEfSuXcQ/exec';
        
        const loadingSpinner = document.getElementById('loading-spinner');
        const dashboardContent = document.getElementById('dashboard-content');
        const refreshButton = document.getElementById('refresh-button');
        const refreshIcon = document.getElementById('refresh-icon');
        const lastUpdatedEl = document.getElementById('last-updated');
        const chartTitle = document.getElementById('chart-title');
        const listTitle = document.getElementById('list-title');

        let schoolChartInstance = null;
        let fullDataSet = null; 
        let currentFilter = 'All'; 

        function updateDashboardView() {
            if (!fullDataSet) return;

            document.querySelectorAll('[data-filter]').forEach(card => {
                card.classList.toggle('active', card.dataset.filter === currentFilter);
            });

            const titleSuffix = currentFilter === 'All' ? '(ç¶œåˆ)' : `(${currentFilter}å ´)`;
            chartTitle.textContent = `å„æ ¡å ±åäººæ•¸åˆ†ä½ˆ ${titleSuffix}`;
            listTitle.textContent = `è©³ç´°æ•¸æ“šåˆ—è¡¨ ${titleSuffix}`;

            const schoolData = fullDataSet.schoolData || {};
            const schoolCountsForView = schoolData[currentFilter] || {};
            renderSchoolData(schoolCountsForView);
        }

        function renderSummaryCards(data) {
            document.getElementById('total-count').textContent = data.total;
            document.getElementById('morning-count').textContent = data.sessionCounts['ä¸Šåˆ'] || 0;
            document.getElementById('afternoon-count').textContent = data.sessionCounts['ä¸‹åˆ'] || 0;
        }

        function renderSchoolData(schoolCounts) {
            const sortedSchools = Object.entries(schoolCounts).sort(([, a], [, b]) => b - a);
            
            const schoolList = document.getElementById('school-list');
            schoolList.innerHTML = '';
            if (sortedSchools.length === 0) {
                schoolList.innerHTML = `<p class="text-gray-500">æ­¤ç¯©é¸æ¢ä»¶å°šç„¡å ±åè³‡æ–™</p>`;
            } else {
                sortedSchools.forEach(([school, count]) => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                    item.innerHTML = `<span class="font-semibold text-gray-700">${school}</span><span class="font-bold text-teal-600 bg-teal-100 px-3 py-1 rounded-full">${count} äºº</span>`;
                    schoolList.appendChild(item);
                });
            }

            const ctx = document.getElementById('school-chart').getContext('2d');
            const topSchools = sortedSchools.slice(0, 10);
            const labels = topSchools.map(item => item[0]);
            const data = topSchools.map(item => item[1]);

            if (schoolChartInstance) {
                schoolChartInstance.destroy();
            }
            schoolChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å ±åäººæ•¸',
                        data: data,
                        backgroundColor: 'rgba(20, 184, 166, 0.7)',
                        borderColor: 'rgba(13, 148, 136, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        async function fetchDashboardData() {
            loadingSpinner.style.display = 'block';
            dashboardContent.classList.add('hidden');
            refreshIcon.classList.add('animate-spin');
            refreshButton.disabled = true;

            try {
                const response = await fetch(`${WEB_APP_URL}?action=getDashboardData`);
                if (!response.ok) throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${response.status} ${response.statusText}`);
                
                const result = await response.json();

                if (!result.success) throw new Error(result.message);
                
                // **ã€å·²ä¿®æ”¹ã€‘** å¢åŠ å°èˆŠè³‡æ–™æ ¼å¼çš„ç›¸å®¹æ€§è™•ç†
                if (!result.data || !result.data.schoolData) {
                    console.error("å¾å¾Œç«¯æ”¶åˆ°çš„è³‡æ–™çµæ§‹ä¸ç¬¦é æœŸ:", result);
                    
                    // æª¢æŸ¥æ˜¯å¦å­˜åœ¨èˆŠçš„ schoolCounts æ ¼å¼
                    if (result.data && result.data.schoolCounts) {
                        console.warn("åµæ¸¬åˆ°èˆŠç‰ˆå¾Œç«¯è³‡æ–™æ ¼å¼ã€‚å„€è¡¨æ¿å°‡ä»¥æœ‰é™åŠŸèƒ½æ¨¡å¼é‹ä½œï¼ˆç„¡æ³•ç¯©é¸å ´æ¬¡ï¼‰ã€‚è«‹å‹™å¿…æ›´æ–°æ‚¨çš„ Google Apps Script ä»¥å•Ÿç”¨å®Œæ•´åŠŸèƒ½ã€‚");
                        // å¾èˆŠæ ¼å¼è½‰æ›ç‚ºæ–°æ ¼å¼ï¼Œä½†åªæœ‰ç¶œåˆè³‡æ–™
                        result.data.schoolData = {
                            'All': result.data.schoolCounts,
                            'ä¸Šåˆ': {},
                            'ä¸‹åˆ': {}
                        };
                    } else {
                        // å¦‚æœé€£èˆŠæ ¼å¼éƒ½æ²’æœ‰ï¼Œæ‰æ‹‹å‡ºéŒ¯èª¤
                        throw new Error("è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚è«‹ç¢ºèªæ‚¨å·²éƒ¨ç½²æœ€æ–°ç‰ˆæœ¬çš„ Google Apps Scriptã€‚");
                    }
                }

                fullDataSet = result.data;
                renderSummaryCards(fullDataSet);
                updateDashboardView();
                
                dashboardContent.classList.remove('hidden');
                const now = new Date();
                lastUpdatedEl.textContent = `æœ€å¾Œæ›´æ–°: ${now.toLocaleTimeString()}`;

            } catch (error) {
                console.error('å„€è¡¨æ¿è³‡æ–™è¼‰å…¥å¤±æ•—:', error);
                
                let detailedMessage = error.message;
                if (error instanceof SyntaxError) {
                    detailedMessage = "å¾Œç«¯å›æ‡‰çš„ä¸æ˜¯æœ‰æ•ˆçš„è³‡æ–™æ ¼å¼ã€‚é€™é€šå¸¸è¡¨ç¤º Apps Script å…§éƒ¨ç™¼ç”ŸéŒ¯èª¤ï¼Œå»ºè­°å‰å¾€ Apps Script å°ˆæ¡ˆé é¢æŸ¥çœ‹ã€ŒåŸ·è¡Œç´€éŒ„ã€ã€‚";
                }
                
                alert(`ç„¡æ³•è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š:\n\n${detailedMessage}`);
            } finally {
                loadingSpinner.style.display = 'none';
                refreshIcon.classList.remove('animate-spin');
                refreshButton.disabled = false;
            }
        }
        
        document.querySelectorAll('[data-filter]').forEach(card => {
            card.addEventListener('click', () => {
                currentFilter = card.dataset.filter;
                updateDashboardView();
            });
        });
        
        refreshButton.addEventListener('click', fetchDashboardData);

        fetchDashboardData();
    });
    </script>
</body>
</html>

